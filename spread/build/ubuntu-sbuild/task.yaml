environment:
    DEB_BUILD_OPTIONS: "parallel=$( nproc ) noopt ${NOCHECK}"
    NO_PKG_MANGLE: 1

systems: [ubuntu-*]

summary: Build Ubuntu packages

execute: |
    add-apt-repository universe
    apt-get update
    apt-get install \
        --yes \
        sbuild \
        schroot \
        ubuntu-dev-tools \
        debootstrap \
        debhelper \
        dh-python \
        lsb-invalid-mta \
        qemu-user-static

    printf "\$mailto = 'null@example.com';\n1;\n" > ~/.sbuildrc

    adduser $USER sbuild
    # set host and build environment up
    source <( dpkg-architecture --print-set --host-arch ${ARCH} )

    sg sbuild -c "mk-sbuild --disable-proposed --arch=${DEB_BUILD_ARCH} --target=${DEB_HOST_ARCH} --eatmydata $(lsb_release --short --codename)"

    cd $SPREAD_PATH

    sbuild -j $(nproc) -v -d $(lsb_release --short --codename) --build=${DEB_BUILD_ARCH} --host=${DEB_HOST_ARCH}
